<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hiragana Quiz</title>
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Segoe UI', sans-serif;
        background-color: #ffffff;
        color: #222;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        transition: background-color 0.4s, color 0.4s;
        font-weight: 600;
      }
      .main-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      body.dark {
        background-color: #2c1f13;
        color: #fff;
      }
      h1 {
        text-align: center;
        font-size: 2.2em;
        margin-bottom: 20px;
        color: #ff9900;
        font-weight: 800;
      }
      body.dark h1 {
        color: #ffdd99;
      }
      #score {
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 15px;
        display: none;
      }
      .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.3s;
      }
      .theme-toggle:hover {
        transform: rotate(20deg);
      }
      .controls {
        margin: 20px 0;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .mode-controls {
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .quiz-type-toggle {
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
      }
      select,
      button,
      input[type='number'] {
        padding: 8px 12px;
        font-size: 15px;
        margin: 0 5px;
        border-radius: 6px;
        border: none;
        transition: background 0.3s, color 0.3s;
      }
      select {
        background: #eee;
        color: #000;
      }
      body.dark select {
        background: #444;
        color: #fff;
      }
      button {
        background: #ff9900;
        color: white;
        cursor: pointer;
      }
      button:disabled {
        background: #bbb !important;
        color: #eee !important;
        cursor: not-allowed;
      }
      button:hover:enabled {
        background: #e68a00;
      }
      input[type='number'] {
        width: 60px;
        background: #eee;
        color: #000;
        border: 1px solid #ccc;
      }
      body.dark input[type='number'] {
        background: #444;
        color: #fff;
        border: 1px solid #888;
      }
      .question {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 20px;
        background: #fff;
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: background 0.4s;
        justify-content: center;
      }
      body.dark .question {
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      }
      .qnum {
        background: #ff9900;
        color: #fff;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
      }
      .sound-btn {
        background: #eee;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: #007799;
        border-radius: 6px;
        padding: 6px 10px;
      }
      body.dark .sound-btn {
        background: #444;
        color: #00d4ff;
      }
      .options {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
      }
      .opt-btn {
        --circle-size: 48px;
        --circle-gap: 16px;
        background: none;
        border: none;
        color: #222;
        font-size: 38px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        position: relative;
        padding-left: calc(var(--circle-size) + var(--circle-gap));
        transition: transform 0.15s, color 0.2s;
        font-weight: 700;
      }
      body.dark .opt-btn {
        color: #eee;
      }
      .opt-btn:hover {
        transform: scale(1.08);
        color: #000;
      }
      body.dark .opt-btn:hover {
        color: #fff;
      }
      .opt-btn::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: var(--circle-size);
        height: var(--circle-size);
        border-radius: 50%;
        border: 3px solid #bbb;
        background: transparent;
        box-sizing: border-box;
        transition: background 0.2s, border-color 0.2s;
      }
      .opt-btn.selected::before {
        background: #1565c0; /* deep blue */
        border-color: #1565c0;
      }
      .opt-btn.selected {
        color: #222; /* Keep text color dark for visibility */
      }
      body.dark .opt-btn.selected::before {
        background: #003366;
        border-color: #00bfff;
      }
      body.dark .opt-btn.selected {
        color: #fff;
      }
      .opt-btn.correct::before {
        background: #4caf50 !important;
        border-color: #388e3c !important;
      }
      .opt-btn.correct {
        color: #fff !important;
        background: #388e3c !important;
        border-radius: 24px;
      }
      .opt-btn.wrong::before {
        background: #f44336 !important;
        border-color: #b71c1c !important;
      }
      .opt-btn.wrong {
        color: #fff !important;
        background: #b71c1c !important;
        border-radius: 24px;
      }
      .opt-btn.highlight::before {
        background: #ffd700 !important;
        border-color: #bfa600 !important;
      }
      .opt-btn.highlight {
        color: #222 !important;
        background: #fffde7 !important;
        border-radius: 24px;
      }
      .range-label {
        margin: 0 6px 0 10px;
        font-weight: 600;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()">☀️</button>
    <div class="main-container">
      <h1>Hiragana MCQ Quiz</h1>
      <div id="score"></div>

      <div class="quiz-type-toggle">
        <button id="normalModeBtn" type="button" class="active">
          Normal Mode
        </button>
        <button id="rangeModeBtn" type="button">Range Mode</button>
      </div>

      <div class="mode-controls">
        <label>
          <input type="radio" name="quizMode" value="romaji" checked />
          Romaji → Hiragana
        </label>
        <label>
          <input type="radio" name="quizMode" value="sound" />
          Sound → Hiragana
        </label>
      </div>

      <div class="controls" id="normalControls">
        <label>Number of Questions: </label>
        <select id="questionLimit">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="46">46</option>
        </select>
        <button id="resetBtn" onclick="generateQuiz()">Reset Quiz</button>
      </div>

      <div class="controls" id="rangeControls" style="display: none">
        <span class="range-label">Start #</span>
        <input type="number" id="rangeStart" min="1" max="46" value="1" />
        <span class="range-label">End #</span>
        <input type="number" id="rangeEnd" min="1" max="46" value="5" />
        <button id="rangeResetBtn" onclick="generateRangeQuiz()">
          Reset Quiz
        </button>
      </div>

      <div id="quizContainer"></div>

      <div class="controls">
        <button id="submitBtn" onclick="submitQuiz()" disabled>Submit</button>
      </div>
    </div>
    <script>
      const hiragana = [
        { char: 'あ', romaji: 'a', audioIndex: 1 },
        { char: 'い', romaji: 'i', audioIndex: 2 },
        { char: 'う', romaji: 'u', audioIndex: 3 },
        { char: 'え', romaji: 'e', audioIndex: 4 },
        { char: 'お', romaji: 'o', audioIndex: 5 },
        { char: 'か', romaji: 'ka', audioIndex: 6 },
        { char: 'き', romaji: 'ki', audioIndex: 7 },
        { char: 'く', romaji: 'ku', audioIndex: 8 },
        { char: 'け', romaji: 'ke', audioIndex: 9 },
        { char: 'こ', romaji: 'ko', audioIndex: 10 },
        { char: 'さ', romaji: 'sa', audioIndex: 11 },
        { char: 'し', romaji: 'shi', audioIndex: 12 },
        { char: 'す', romaji: 'su', audioIndex: 13 },
        { char: 'せ', romaji: 'se', audioIndex: 14 },
        { char: 'そ', romaji: 'so', audioIndex: 15 },
        { char: 'た', romaji: 'ta', audioIndex: 16 },
        { char: 'ち', romaji: 'chi', audioIndex: 17 },
        { char: 'つ', romaji: 'tsu', audioIndex: 18 },
        { char: 'て', romaji: 'te', audioIndex: 19 },
        { char: 'と', romaji: 'to', audioIndex: 20 },
        { char: 'な', romaji: 'na', audioIndex: 21 },
        { char: 'に', romaji: 'ni', audioIndex: 22 },
        { char: 'ぬ', romaji: 'nu', audioIndex: 23 },
        { char: 'ね', romaji: 'ne', audioIndex: 24 },
        { char: 'の', romaji: 'no', audioIndex: 25 },
        { char: 'は', romaji: 'ha', audioIndex: 26 },
        { char: 'ひ', romaji: 'hi', audioIndex: 27 },
        { char: 'ふ', romaji: 'fu', audioIndex: 28 },
        { char: 'へ', romaji: 'he', audioIndex: 29 },
        { char: 'ほ', romaji: 'ho', audioIndex: 30 },
        { char: 'ま', romaji: 'ma', audioIndex: 31 },
        { char: 'み', romaji: 'mi', audioIndex: 32 },
        { char: 'む', romaji: 'mu', audioIndex: 33 },
        { char: 'め', romaji: 'me', audioIndex: 34 },
        { char: 'も', romaji: 'mo', audioIndex: 35 },
        { char: 'や', romaji: 'ya', audioIndex: 36 },
        { char: 'ゆ', romaji: 'yu', audioIndex: 37 },
        { char: 'よ', romaji: 'yo', audioIndex: 38 },
        { char: 'ら', romaji: 'ra', audioIndex: 39 },
        { char: 'り', romaji: 'ri', audioIndex: 40 },
        { char: 'る', romaji: 'ru', audioIndex: 41 },
        { char: 'れ', romaji: 're', audioIndex: 42 },
        { char: 'ろ', romaji: 'ro', audioIndex: 43 },
        { char: 'わ', romaji: 'wa', audioIndex: 44 },
        { char: 'を', romaji: 'wo', audioIndex: 45 },
        { char: 'ん', romaji: 'n', audioIndex: 46 },
      ];

      let quizData = [];
      let userAnswers = [];
      let darkMode = false;
      let quizMode = 'romaji';
      let audioElements = {};
      let quizType = 'normal'; // 'normal' or 'range'

      function preloadAudioFiles() {
        hiragana.forEach((item) => {
          const audio = new Audio(
            `hiragana_chunks/voice_${item.audioIndex}.mp3`
          );
          audioElements[item.char] = audio;
        });
      }

      function shuffleArray(arr) {
        // Fisher-Yates shuffle for true randomness
        const array = arr.slice();
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function renderQuiz() {
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';
        document.getElementById('score').style.display = 'none';
        document.getElementById('submitBtn').disabled = userAnswers.some(
          (ans) => ans === null
        );

        quizData.forEach((q, index) => {
          // Distractors: pick 3 unique chars not the answer
          const distractors = shuffleArray(
            hiragana.filter((h) => h.char !== q.char)
          )
            .slice(0, 3)
            .map((o) => o.char);
          const options = shuffleArray([q.char, ...distractors]);

          let promptHtml =
            quizMode === 'romaji'
              ? `<span style="font-size:1.3em;font-weight:700;margin-right:10px;">${q.romaji}</span>`
              : `<button class="sound-btn" onclick="playSound('${q.char}')">🔊</button>`;

          container.innerHTML += `
            <div class="question" id="q${index}">
              <div class="qnum">${index + 1}</div>
              ${promptHtml}
              <div class="options">
                ${options
                  .map(
                    (opt) =>
                      `<button class="opt-btn${
                        userAnswers[index] === opt ? ' selected' : ''
                      }" onclick="selectOption(${index},'${opt}',this)">${opt}</button>`
                  )
                  .join('')}
              </div>
            </div>`;
        });
      }

      function generateQuiz() {
        // Normal mode: use questionLimit
        const limit = parseInt(document.getElementById('questionLimit').value);
        quizData = shuffleArray(hiragana).slice(0, limit);
        userAnswers = Array(limit).fill(null);
        renderQuiz();
      }

      function generateRangeQuiz() {
        // Range mode: use rangeStart and rangeEnd
        let start = parseInt(document.getElementById('rangeStart').value);
        let end = parseInt(document.getElementById('rangeEnd').value);
        if (isNaN(start) || isNaN(end)) {
          alert('Please enter valid numbers for start and end.');
          return;
        }
        if (start < 1) start = 1;
        if (end > hiragana.length) end = hiragana.length;
        if (start > end) [start, end] = [end, start];
        // Get the range, then shuffle for random order
        quizData = shuffleArray(hiragana.slice(start - 1, end));
        userAnswers = Array(quizData.length).fill(null);
        renderQuiz();
      }

      function selectOption(qIndex, answer, btn) {
        userAnswers[qIndex] = answer;
        const buttons = document
          .getElementById(`q${qIndex}`)
          .querySelectorAll('.options .opt-btn');
        buttons.forEach((b) => b.classList.remove('selected'));
        btn.classList.add('selected');

        // Enable submit only if all questions are answered
        const allAnswered = userAnswers.every((ans) => ans !== null);
        document.getElementById('submitBtn').disabled = !allAnswered;
      }

      function submitQuiz() {
        let scoreCount = 0;
        quizData.forEach((q, index) => {
          const correctChar = q.char;
          const qDiv = document.getElementById(`q${index}`);
          qDiv.querySelectorAll('.options button').forEach((btn) => {
            const isCorrectBtn = btn.textContent === correctChar;
            const isUserBtn = btn.textContent === userAnswers[index];
            btn.classList.remove('selected');

            if (isCorrectBtn && isUserBtn) {
              btn.classList.add('correct');
              scoreCount++;
            } else if (isCorrectBtn) {
              btn.classList.add('highlight');
            } else if (isUserBtn) {
              btn.classList.add('wrong');
            }
            btn.disabled = true;
          });
        });

        document.getElementById('submitBtn').disabled = true;
        const scoreDisplay = document.getElementById('score');
        const pct = Math.round((scoreCount / quizData.length) * 100);
        scoreDisplay.textContent = `Score: ${scoreCount}/${quizData.length} (${pct}%)`;
        scoreDisplay.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // Play audio from file, fallback to Web Speech API if not loaded
      function playSound(char) {
        const audio = audioElements[char];
        if (audio) {
          audio.currentTime = 0;
          audio.play().catch(() => {
            // fallback to Web Speech API if audio fails
            speakKana(char);
          });
        } else {
          speakKana(char);
        }
      }

      // Fallback: Use Web Speech API for kana pronunciation
      function speakKana(kana) {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const utter = new SpeechSynthesisUtterance(kana);
          const voices = window.speechSynthesis.getVoices();
          const jpVoice = voices.find((v) => v.lang && v.lang.startsWith('ja'));
          if (jpVoice) {
            utter.voice = jpVoice;
          }
          utter.lang = 'ja-JP';
          window.speechSynthesis.speak(utter);
        } else {
          alert('Speech synthesis not supported in this browser.');
        }
      }

      function toggleTheme() {
        darkMode = !darkMode;
        document.body.classList.toggle('dark', darkMode);
        document.querySelector('.theme-toggle').textContent = darkMode
          ? '🌙'
          : '☀️';
      }

      function switchToNormalMode() {
        quizType = 'normal';
        document.getElementById('normalControls').style.display = '';
        document.getElementById('rangeControls').style.display = 'none';
        document.getElementById('normalModeBtn').classList.add('active');
        document.getElementById('rangeModeBtn').classList.remove('active');
        generateQuiz();
      }

      function switchToRangeMode() {
        quizType = 'range';
        document.getElementById('normalControls').style.display = 'none';
        document.getElementById('rangeControls').style.display = '';
        document.getElementById('normalModeBtn').classList.remove('active');
        document.getElementById('rangeModeBtn').classList.add('active');
        generateRangeQuiz();
      }

      document.addEventListener('DOMContentLoaded', () => {
        preloadAudioFiles();

        document.querySelectorAll('input[name="quizMode"]').forEach((radio) => {
          radio.addEventListener('change', function () {
            quizMode = this.value;
            renderQuiz(); // Only re-render, don't regenerate quizData
          });
        });

        document
          .getElementById('questionLimit')
          .addEventListener('change', function () {
            if (quizType === 'normal') generateQuiz();
          });

        document
          .getElementById('normalModeBtn')
          .addEventListener('click', switchToNormalMode);
        document
          .getElementById('rangeModeBtn')
          .addEventListener('click', switchToRangeMode);

        document
          .getElementById('rangeStart')
          .addEventListener('change', function () {
            if (quizType === 'range') generateRangeQuiz();
          });
        document
          .getElementById('rangeEnd')
          .addEventListener('change', function () {
            if (quizType === 'range') generateRangeQuiz();
          });

        // Initial mode
        switchToNormalMode();
      });
    </script>
  </body>
</html>
