<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Hiragana Quiz</title>
    <!-- Google Fonts for Noto Sans JP -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@700&display=swap"
      rel="stylesheet"
    />
    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      body {
        font-family: 'Segoe UI', sans-serif;
        background-color: #ffffff;
        color: #222;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        transition: background-color 0.4s, color 0.4s;
        font-weight: 600;
      }
      .main-container {
        width: 100%;
        max-width: 900px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      body.dark {
        background-color: #2c1f13;
        color: #fff;
      }
      h1 {
        text-align: center;
        font-size: 2.2em;
        margin-bottom: 20px;
        color: #ff9900;
        font-weight: 800;
      }
      body.dark h1 {
        color: #ffdd99;
      }
      #score {
        text-align: center;
        font-size: 1.5em;
        font-weight: bold;
        margin-bottom: 15px;
        display: none;
      }
      .theme-toggle {
        position: absolute;
        top: 20px;
        right: 20px;
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.3s;
      }
      .theme-toggle:hover {
        transform: rotate(20deg);
      }
      .controls {
        margin: 20px 0;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .mode-controls {
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }
      .quiz-type-toggle {
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
      }
      .font-controls,
      .voice-controls {
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
      }
      .romaki-controls {
        margin-bottom: 10px;
        text-align: center;
        width: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 16px;
      }
      select,
      button,
      input[type='number'] {
        padding: 8px 12px;
        font-size: 15px;
        margin: 0 5px;
        border-radius: 6px;
        border: none;
        transition: background 0.3s, color 0.3s;
      }
      select {
        background: #eee;
        color: #000;
      }
      body.dark select {
        background: #444;
        color: #fff;
      }
      button {
        background: #ff9900;
        color: white;
        cursor: pointer;
      }
      button:disabled {
        background: #bbb !important;
        color: #eee !important;
        cursor: not-allowed;
      }
      button:hover:enabled {
        background: #e68a00;
      }
      input[type='number'] {
        width: 60px;
        background: #eee;
        color: #000;
        border: 1px solid #ccc;
      }
      body.dark input[type='number'] {
        background: #444;
        color: #fff;
        border: 1px solid #888;
      }
      .question {
        display: flex;
        align-items: center;
        gap: 14px;
        margin-bottom: 20px;
        background: #fff;
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        transition: background 0.4s;
        justify-content: center;
      }
      body.dark .question {
        background: rgba(255, 255, 255, 0.05);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.4);
      }
      .qnum {
        background: #ff9900;
        color: #fff;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        font-weight: bold;
      }
      .sound-btn {
        background: #eee;
        border: none;
        cursor: pointer;
        font-size: 18px;
        color: #007799;
        border-radius: 6px;
        padding: 6px 10px;
      }
      body.dark .sound-btn {
        background: #444;
        color: #00d4ff;
      }
      .options {
        display: flex;
        flex-wrap: wrap;
        gap: 18px;
      }
      .opt-btn {
        --circle-size: 48px;
        --circle-gap: 16px;
        background: none;
        border: none;
        color: #222;
        font-size: 38px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        position: relative;
        padding-left: calc(var(--circle-size) + var(--circle-gap));
        transition: transform 0.15s, color 0.2s;
        font-weight: 700;
      }
      body.dark .opt-btn {
        color: #eee;
      }
      .opt-btn:hover {
        transform: scale(1.08);
        color: #000;
      }
      body.dark .opt-btn:hover {
        color: #fff;
      }
      .opt-btn::before {
        content: '';
        position: absolute;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: var(--circle-size);
        height: var(--circle-size);
        border-radius: 50%;
        border: 3px solid #bbb;
        background: transparent;
        box-sizing: border-box;
        transition: background 0.2s, border-color 0.2s;
      }
      .opt-btn.selected::before {
        background: #1565c0; /* deep blue */
        border-color: #1565c0;
      }
      .opt-btn.selected {
        color: #222; /* Keep text color dark for visibility */
      }
      body.dark .opt-btn.selected::before {
        background: #003366;
        border-color: #00bfff;
      }
      body.dark .opt-btn.selected {
        color: #fff;
      }
      .opt-btn.correct::before {
        background: #4caf50 !important;
        border-color: #388e3c !important;
      }
      .opt-btn.correct {
        color: #fff !important;
        background: #388e3c !important;
        border-radius: 24px;
      }
      .opt-btn.wrong::before {
        background: #f44336 !important;
        border-color: #b71c1c !important;
      }
      .opt-btn.wrong {
        color: #fff !important;
        background: #b71c1c !important;
        border-radius: 24px;
      }
      .opt-btn.highlight::before {
        background: #ffd700 !important;
        border-color: #bfa600 !important;
      }
      .opt-btn.highlight {
        color: #222 !important;
        background: #fffde7 !important;
        border-radius: 24px;
      }
      .range-label {
        margin: 0 6px 0 10px;
        font-weight: 600;
      }
      .range-btn {
        padding: 4px 10px;
        font-size: 18px;
        margin: 0 2px;
        background: #ccc;
        color: #333;
        border-radius: 5px;
        border: none;
        cursor: pointer;
        transition: background 0.2s;
      }
      .range-btn:hover:enabled {
        background: #ff9900;
        color: #fff;
      }
      .range-btn:disabled {
        background: #eee;
        color: #aaa;
        cursor: not-allowed;
      }
      body.dark .range-btn {
        background: #444;
        color: #eee;
      }
      body.dark .range-btn:hover:enabled {
        background: #ff9900;
        color: #fff;
      }
      body.dark .range-btn:disabled {
        background: #222;
        color: #666;
      }
      /* Japanese font class */
      .japanese-font-default {
        font-family: 'Segoe UI', 'Meiryo', 'Yu Gothic', 'MS PGothic', sans-serif;
      }
      .japanese-font-noto {
        font-family: 'Noto Sans JP', 'Segoe UI', 'Meiryo', 'Yu Gothic',
          'MS PGothic', sans-serif;
      }
      /* Login Modal */
      #loginModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      #loginModal .login-box {
        background: #fff;
        padding: 30px 40px;
        border-radius: 12px;
        box-shadow: 0 4px 20px #0003;
        min-width: 300px;
      }
      #loginModal input {
        width: 100%;
        padding: 8px;
        font-size: 1em;
        margin-bottom: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
      }
      #loginModal button {
        width: 100%;
        padding: 10px;
        font-size: 1em;
        background: #ff9900;
        color: #fff;
        border: none;
        border-radius: 6px;
        cursor: pointer;
      }
      #loginModal #loginError {
        color: #c00;
        margin-top: 10px;
        display: none;
      }
    </style>
  </head>
  <body>
    <button class="theme-toggle" onclick="toggleTheme()">‚òÄÔ∏è</button>
    <div class="main-container">
      <h1>Hiragana MCQ Quiz</h1>
      <div id="score"></div>

      <div class="voice-controls">
        <label for="voiceSelect">Voice:</label>
        <select id="voiceSelect">
          <option value="voice01">Voice 01</option>
          <option value="voice02">Voice 02</option>
          <option value="random">Random</option>
        </select>
      </div>

      <div class="font-controls">
        <label for="fontSelect">Japanese Font:</label>
        <select id="fontSelect">
          <option value="default">Default</option>
          <option value="noto">Noto Sans CJK JP</option>
        </select>
      </div>

      <div class="mode-controls" id="mainModeControls">
        <label>
          <input type="radio" name="quizMode" value="sound" checked />
          Sound ‚Üí Hiragana
        </label>
        <label class="hidden-quizmode" style="display: none">
          <input type="radio" name="quizMode" value="romaji" />
          Romaji ‚Üí Hiragana
        </label>
        <label class="hidden-quizmode" style="display: none">
          <input type="radio" name="quizMode" value="sound2romaji" />
          Sound ‚Üí Romaji
        </label>
        <label class="hidden-quizmode" style="display: none">
          <input type="radio" name="quizMode" value="hiragana2romaji" />
          Hiragana ‚Üí Romaji
        </label>
      </div>

      <div class="quiz-type-toggle">
        <button id="normalModeBtn" type="button" class="active">
          Normal Mode
        </button>
        <button
          id="rangeModeBtn"
          type="button"
          class="hidden-quizmode"
          style="display: none"
        >
          Range Mode
        </button>
        <button
          id="romakiModeBtn"
          type="button"
          class="hidden-quizmode"
          style="display: none"
        >
          Romaji Mode
        </button>
      </div>

      <div class="romaki-controls" id="romakiControls" style="display: none">
        <label class="hidden-quizmode" style="display: none">
          <input type="radio" name="romakiMode" value="sound2romaji" checked />
          Sound ‚Üí Romaji
        </label>
        <label class="hidden-quizmode" style="display: none">
          <input type="radio" name="romakiMode" value="hiragana2romaji" />
          Hiragana ‚Üí Romaji
        </label>
      </div>

      <div class="controls" id="normalControls">
        <label>Number of Questions: </label>
        <select id="questionLimit">
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
          <option value="30">30</option>
          <option value="46">46</option>
        </select>
        <button id="resetBtn" onclick="generateQuiz()">Reset Quiz</button>
      </div>

      <div class="controls" id="rangeControls" style="display: none">
        <button class="range-btn" id="startDecBtn" type="button">-5</button>
        <span class="range-label">Start #</span>
        <input type="number" id="rangeStart" min="1" max="46" value="1" />
        <button class="range-btn" id="startIncBtn" type="button">+5</button>
        <button class="range-btn" id="endDecBtn" type="button">-5</button>
        <span class="range-label">End #</span>
        <input type="number" id="rangeEnd" min="1" max="46" value="5" />
        <button class="range-btn" id="endIncBtn" type="button">+5</button>
        <button id="rangeResetBtn" onclick="generateRangeQuiz()">
          Reset Quiz
        </button>
      </div>

      <div id="quizContainer"></div>

      <div class="controls">
        <button id="submitBtn" onclick="submitQuiz()" disabled>Submit</button>
      </div>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" style="display: none">
      <div class="login-box">
        <h2 style="margin-top: 0">Login</h2>
        <input
          id="loginUser"
          type="text"
          placeholder="Username"
          autocomplete="username"
        />
        <input
          id="loginPass"
          type="password"
          placeholder="Password"
          autocomplete="current-password"
        />
        <button onclick="doLogin()">Login</button>
        <div id="loginError">Invalid credentials.</div>
      </div>
    </div>

    <button
      id="showLoginBtn"
      style="position: fixed; bottom: 18px; right: 18px; z-index: 1000"
    >
      üîí Login
    </button>

    <script>
      const hiragana = [
        { char: '„ÅÇ', romaji: 'a', audioIndex: 1 },
        { char: '„ÅÑ', romaji: 'i', audioIndex: 2 },
        { char: '„ÅÜ', romaji: 'u', audioIndex: 3 },
        { char: '„Åà', romaji: 'e', audioIndex: 4 },
        { char: '„Åä', romaji: 'o', audioIndex: 5 },
        { char: '„Åã', romaji: 'ka', audioIndex: 6 },
        { char: '„Åç', romaji: 'ki', audioIndex: 7 },
        { char: '„Åè', romaji: 'ku', audioIndex: 8 },
        { char: '„Åë', romaji: 'ke', audioIndex: 9 },
        { char: '„Åì', romaji: 'ko', audioIndex: 10 },
        { char: '„Åï', romaji: 'sa', audioIndex: 11 },
        { char: '„Åó', romaji: 'shi', audioIndex: 12 },
        { char: '„Åô', romaji: 'su', audioIndex: 13 },
        { char: '„Åõ', romaji: 'se', audioIndex: 14 },
        { char: '„Åù', romaji: 'so', audioIndex: 15 },
        { char: '„Åü', romaji: 'ta', audioIndex: 16 },
        { char: '„Å°', romaji: 'chi', audioIndex: 17 },
        { char: '„Å§', romaji: 'tsu', audioIndex: 18 },
        { char: '„Å¶', romaji: 'te', audioIndex: 19 },
        { char: '„Å®', romaji: 'to', audioIndex: 20 },
        { char: '„Å™', romaji: 'na', audioIndex: 21 },
        { char: '„Å´', romaji: 'ni', audioIndex: 22 },
        { char: '„Å¨', romaji: 'nu', audioIndex: 23 },
        { char: '„Å≠', romaji: 'ne', audioIndex: 24 },
        { char: '„ÅÆ', romaji: 'no', audioIndex: 25 },
        { char: '„ÅØ', romaji: 'ha', audioIndex: 26 },
        { char: '„Å≤', romaji: 'hi', audioIndex: 27 },
        { char: '„Åµ', romaji: 'fu', audioIndex: 28 },
        { char: '„Å∏', romaji: 'he', audioIndex: 29 },
        { char: '„Åª', romaji: 'ho', audioIndex: 30 },
        { char: '„Åæ', romaji: 'ma', audioIndex: 31 },
        { char: '„Åø', romaji: 'mi', audioIndex: 32 },
        { char: '„ÇÄ', romaji: 'mu', audioIndex: 33 },
        { char: '„ÇÅ', romaji: 'me', audioIndex: 34 },
        { char: '„ÇÇ', romaji: 'mo', audioIndex: 35 },
        { char: '„ÇÑ', romaji: 'ya', audioIndex: 36 },
        { char: '„ÇÜ', romaji: 'yu', audioIndex: 37 },
        { char: '„Çà', romaji: 'yo', audioIndex: 38 },
        { char: '„Çâ', romaji: 'ra', audioIndex: 39 },
        { char: '„Çä', romaji: 'ri', audioIndex: 40 },
        { char: '„Çã', romaji: 'ru', audioIndex: 41 },
        { char: '„Çå', romaji: 're', audioIndex: 42 },
        { char: '„Çç', romaji: 'ro', audioIndex: 43 },
        { char: '„Çè', romaji: 'wa', audioIndex: 44 },
        { char: '„Çí', romaji: 'wo', audioIndex: 45 },
        { char: '„Çì', romaji: 'n', audioIndex: 46 },
      ];

      let quizData = [];
      let userAnswers = [];
      let darkMode = false;
      let quizMode = 'sound'; // default to Sound ‚Üí Hiragana
      let romakiMode = 'sound2romaji'; // for romaki mode
      let audioElements = { voice01: {}, voice02: {} };
      let quizType = 'normal'; // 'normal' or 'range'
      let japaneseFont = 'default'; // 'default' or 'noto'
      let currentQuizMainMode = 'main'; // 'main' or 'romaki'
      let voiceMode = 'voice01'; // 'voice01', 'voice02', 'random'
      let isLoggedIn = false;

      function preloadAudioFiles() {
        hiragana.forEach((item) => {
          audioElements.voice01[item.char] = new Audio(
            `hiragana_chunks/voice_${item.audioIndex}.mp3`
          );
          audioElements.voice02[item.char] = new Audio(
            `hiragana_chunks02/voice_${item.audioIndex}.mp3`
          );
        });
      }

      function shuffleArray(arr) {
        const array = arr.slice();
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
      }

      function renderQuiz() {
        const container = document.getElementById('quizContainer');
        container.innerHTML = '';
        document.getElementById('score').style.display = 'none';
        document.getElementById('submitBtn').disabled = userAnswers.some(
          (ans) => ans === null
        );

        quizData.forEach((q, index) => {
          let distractors, options, promptHtml, fontClass;
          fontClass =
            japaneseFont === 'noto'
              ? 'japanese-font-noto'
              : 'japanese-font-default';

          if (currentQuizMainMode === 'main') {
            if (quizMode === 'sound') {
              distractors = shuffleArray(
                hiragana.filter((h) => h.char !== q.char)
              )
                .slice(0, 3)
                .map((o) => o.char);
              options = shuffleArray([q.char, ...distractors]);
              promptHtml = `<button class="sound-btn" onclick="playSound('${q.char}')">üîä</button>`;
            } else if (quizMode === 'romaji') {
              distractors = shuffleArray(
                hiragana.filter((h) => h.char !== q.char)
              )
                .slice(0, 3)
                .map((o) => o.char);
              options = shuffleArray([q.char, ...distractors]);
              promptHtml = `<span class="${fontClass}" style="font-size:1.3em;font-weight:700;margin-right:10px;">${q.romaji}</span>`;
            } else if (quizMode === 'sound2romaji') {
              distractors = shuffleArray(
                hiragana.filter((h) => h.romaji !== q.romaji)
              )
                .slice(0, 3)
                .map((o) => o.romaji);
              options = shuffleArray([q.romaji, ...distractors]);
              promptHtml = `<button class="sound-btn" onclick="playSound('${q.char}')">üîä</button>`;
            } else if (quizMode === 'hiragana2romaji') {
              distractors = shuffleArray(
                hiragana.filter((h) => h.romaji !== q.romaji)
              )
                .slice(0, 3)
                .map((o) => o.romaji);
              options = shuffleArray([q.romaji, ...distractors]);
              promptHtml = `<span class="${fontClass}" style="font-size:2em;font-weight:700;margin-right:10px;">${q.char}</span>`;
            }
          } else if (currentQuizMainMode === 'romaki') {
            if (romakiMode === 'sound2romaji') {
              distractors = shuffleArray(
                hiragana.filter((h) => h.romaji !== q.romaji)
              )
                .slice(0, 3)
                .map((o) => o.romaji);
              options = shuffleArray([q.romaji, ...distractors]);
              promptHtml = `<button class="sound-btn" onclick="playSound('${q.char}')">üîä</button>`;
            } else {
              distractors = shuffleArray(
                hiragana.filter((h) => h.romaji !== q.romaji)
              )
                .slice(0, 3)
                .map((o) => o.romaji);
              options = shuffleArray([q.romaji, ...distractors]);
              promptHtml = `<span class="${fontClass}" style="font-size:2em;font-weight:700;margin-right:10px;">${q.char}</span>`;
            }
          }

          container.innerHTML += `
            <div class="question" id="q${index}">
              <div class="qnum">${index + 1}</div>
              ${promptHtml}
              <div class="options">
                ${options
                  .map(
                    (opt) =>
                      `<button class="opt-btn ${fontClass}${
                        userAnswers[index] === opt ? ' selected' : ''
                      }" onclick="selectOption(${index},'${opt}',this)">${opt}</button>`
                  )
                  .join('')}
              </div>
            </div>`;
        });
      }

      function generateQuiz() {
        const limit = parseInt(document.getElementById('questionLimit').value);
        quizData = shuffleArray(hiragana).slice(0, limit);
        userAnswers = Array(limit).fill(null);
        renderQuiz();
      }

      function generateRangeQuiz() {
        let start = parseInt(document.getElementById('rangeStart').value);
        let end = parseInt(document.getElementById('rangeEnd').value);
        if (isNaN(start) || isNaN(end)) {
          alert('Please enter valid numbers for start and end.');
          return;
        }
        if (start < 1) start = 1;
        if (end > hiragana.length) end = hiragana.length;
        if (start > end) [start, end] = [end, start];
        quizData = shuffleArray(hiragana.slice(start - 1, end));
        userAnswers = Array(quizData.length).fill(null);
        renderQuiz();
      }

      function generateRomakiQuiz() {
        let data;
        if (quizType === 'normal') {
          const limit = parseInt(
            document.getElementById('questionLimit').value
          );
          data = shuffleArray(hiragana).slice(0, limit);
        } else {
          let start = parseInt(document.getElementById('rangeStart').value);
          let end = parseInt(document.getElementById('rangeEnd').value);
          if (isNaN(start) || isNaN(end)) {
            alert('Please enter valid numbers for start and end.');
            return;
          }
          if (start < 1) start = 1;
          if (end > hiragana.length) end = hiragana.length;
          if (start > end) [start, end] = [end, start];
          data = shuffleArray(hiragana.slice(start - 1, end));
        }
        quizData = data;
        userAnswers = Array(quizData.length).fill(null);
        renderQuiz();
      }

      function selectOption(qIndex, answer, btn) {
        userAnswers[qIndex] = answer;
        const buttons = document
          .getElementById(`q${qIndex}`)
          .querySelectorAll('.options .opt-btn');
        buttons.forEach((b) => b.classList.remove('selected'));
        btn.classList.add('selected');

        const allAnswered = userAnswers.every((ans) => ans !== null);
        document.getElementById('submitBtn').disabled = !allAnswered;
      }

      function submitQuiz() {
        let scoreCount = 0;
        quizData.forEach((q, index) => {
          let correctAnswer;
          if (currentQuizMainMode === 'main') {
            if (quizMode === 'sound' || quizMode === 'romaji') {
              correctAnswer = q.char;
            } else if (
              quizMode === 'sound2romaji' ||
              quizMode === 'hiragana2romaji'
            ) {
              correctAnswer = q.romaji;
            }
          } else if (currentQuizMainMode === 'romaki') {
            correctAnswer = q.romaji;
          }
          const qDiv = document.getElementById(`q${index}`);
          qDiv.querySelectorAll('.options button').forEach((btn) => {
            const isCorrectBtn = btn.textContent === correctAnswer;
            const isUserBtn = btn.textContent === userAnswers[index];
            btn.classList.remove('selected');

            if (isCorrectBtn && isUserBtn) {
              btn.classList.add('correct');
              scoreCount++;
            } else if (isCorrectBtn) {
              btn.classList.add('highlight');
            } else if (isUserBtn) {
              btn.classList.add('wrong');
            }
            btn.disabled = true;
          });
        });

        document.getElementById('submitBtn').disabled = true;
        const scoreDisplay = document.getElementById('score');
        const pct = Math.round((scoreCount / quizData.length) * 100);
        scoreDisplay.textContent = `Score: ${scoreCount}/${quizData.length} (${pct}%)`;
        scoreDisplay.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function playSound(char) {
        let audio;
        if (voiceMode === 'random') {
          const pick = Math.random() < 0.5 ? 'voice01' : 'voice02';
          audio = audioElements[pick][char];
        } else {
          audio = audioElements[voiceMode][char];
        }
        if (audio) {
          audio.currentTime = 0;
          audio.play().catch(() => {
            speakKana(char);
          });
        } else {
          speakKana(char);
        }
      }

      function speakKana(kana) {
        if ('speechSynthesis' in window) {
          window.speechSynthesis.cancel();
          const utter = new SpeechSynthesisUtterance(kana);
          const voices = window.speechSynthesis.getVoices();
          const jpVoice = voices.find((v) => v.lang && v.lang.startsWith('ja'));
          if (jpVoice) {
            utter.voice = jpVoice;
          }
          utter.lang = 'ja-JP';
          window.speechSynthesis.speak(utter);
        } else {
          alert('Speech synthesis not supported in this browser.');
        }
      }

      function toggleTheme() {
        darkMode = !darkMode;
        document.body.classList.toggle('dark', darkMode);
        document.querySelector('.theme-toggle').textContent = darkMode
          ? 'üåô'
          : '‚òÄÔ∏è';
      }

      function switchToNormalMode() {
        quizType = 'normal';
        currentQuizMainMode = 'main';
        document.getElementById('normalControls').style.display = '';
        document.getElementById('rangeControls').style.display = 'none';
        document.getElementById('mainModeControls').style.display = '';
        document.getElementById('romakiControls').style.display = 'none';
        document.getElementById('normalModeBtn').classList.add('active');
        document.getElementById('rangeModeBtn').classList.remove('active');
        document.getElementById('romakiModeBtn').classList.remove('active');
        generateQuiz();
      }

      function switchToRangeMode() {
        quizType = 'range';
        currentQuizMainMode = 'main';
        document.getElementById('normalControls').style.display = 'none';
        document.getElementById('rangeControls').style.display = '';
        document.getElementById('mainModeControls').style.display = '';
        document.getElementById('romakiControls').style.display = 'none';
        document.getElementById('normalModeBtn').classList.remove('active');
        document.getElementById('rangeModeBtn').classList.add('active');
        document.getElementById('romakiModeBtn').classList.remove('active');
        generateRangeQuiz();
      }

      function switchToRomakiMode() {
        document.getElementById('normalControls').style.display =
          quizType === 'normal' ? '' : 'none';
        document.getElementById('rangeControls').style.display =
          quizType === 'range' ? '' : 'none';
        document.getElementById('mainModeControls').style.display = 'none';
        document.getElementById('romakiControls').style.display = '';
        document.getElementById('normalModeBtn').classList.remove('active');
        document.getElementById('rangeModeBtn').classList.remove('active');
        document.getElementById('romakiModeBtn').classList.add('active');
        currentQuizMainMode = 'romaki';
        generateRomakiQuiz();
      }

      function clamp(val, min, max) {
        return Math.max(min, Math.min(max, val));
      }

      function updateJapaneseFont() {
        japaneseFont = document.getElementById('fontSelect').value;
        renderQuiz();
      }

      function updateVoiceMode() {
        voiceMode = document.getElementById('voiceSelect').value;
      }

      // LOGIN LOGIC
      function doLogin() {
        var user = document.getElementById('loginUser').value.trim();
        var pass = document.getElementById('loginPass').value;
        if (user === 'Bejt' && pass === 'Bjet2025') {
          document.getElementById('loginModal').style.display = 'none';
          isLoggedIn = true;
          showHiddenQuizModes();
        } else {
          document.getElementById('loginError').style.display = 'block';
        }
      }

      function showHiddenQuizModes() {
        document.querySelectorAll('.hidden-quizmode').forEach((el) => {
          el.style.display = '';
        });
      }
      function hideHiddenQuizModes() {
        document.querySelectorAll('.hidden-quizmode').forEach((el) => {
          el.style.display = 'none';
        });
      }

      document.addEventListener('DOMContentLoaded', () => {
        preloadAudioFiles();

        document
          .getElementById('voiceSelect')
          .addEventListener('change', function () {
            updateVoiceMode();
          });

        document.querySelectorAll('input[name="quizMode"]').forEach((radio) => {
          radio.addEventListener('change', function () {
            quizMode = this.value;
            if (currentQuizMainMode === 'main') renderQuiz();
          });
        });

        document
          .querySelectorAll('input[name="romakiMode"]')
          .forEach((radio) => {
            radio.addEventListener('change', function () {
              romakiMode = this.value;
              if (currentQuizMainMode === 'romaki') generateRomakiQuiz();
            });
          });

        document
          .getElementById('questionLimit')
          .addEventListener('change', function () {
            if (currentQuizMainMode === 'main' && quizType === 'normal')
              generateQuiz();
            if (currentQuizMainMode === 'romaki' && quizType === 'normal')
              generateRomakiQuiz();
          });

        document
          .getElementById('normalModeBtn')
          .addEventListener('click', switchToNormalMode);
        document
          .getElementById('rangeModeBtn')
          .addEventListener('click', switchToRangeMode);
        document
          .getElementById('romakiModeBtn')
          .addEventListener('click', switchToRomakiMode);

        document
          .getElementById('rangeStart')
          .addEventListener('change', function () {
            if (quizType === 'range' && currentQuizMainMode === 'main')
              generateRangeQuiz();
            if (quizType === 'range' && currentQuizMainMode === 'romaki')
              generateRomakiQuiz();
          });
        document
          .getElementById('rangeEnd')
          .addEventListener('change', function () {
            if (quizType === 'range' && currentQuizMainMode === 'main')
              generateRangeQuiz();
            if (quizType === 'range' && currentQuizMainMode === 'romaki')
              generateRomakiQuiz();
          });

        document
          .getElementById('startDecBtn')
          .addEventListener('click', function () {
            let start = parseInt(document.getElementById('rangeStart').value);
            start = clamp(start - 5, 1, 46);
            document.getElementById('rangeStart').value = start;
            if (quizType === 'range' && currentQuizMainMode === 'main')
              generateRangeQuiz();
            if (quizType === 'range' && currentQuizMainMode === 'romaki')
              generateRomakiQuiz();
          });
        document
          .getElementById('startIncBtn')
          .addEventListener('click', function () {
            let start = parseInt(document.getElementById('rangeStart').value);
            start = clamp(start + 5, 1, 46);
            document.getElementById('rangeStart').value = start;
            if (quizType === 'range' && currentQuizMainMode === 'main')
              generateRangeQuiz();
            if (quizType === 'range' && currentQuizMainMode === 'romaki')
              generateRomakiQuiz();
          });
        document
          .getElementById('endDecBtn')
          .addEventListener('click', function () {
            let end = parseInt(document.getElementById('rangeEnd').value);
            end = clamp(end - 5, 1, 46);
            document.getElementById('rangeEnd').value = end;
            if (quizType === 'range' && currentQuizMainMode === 'main')
              generateRangeQuiz();
            if (quizType === 'range' && currentQuizMainMode === 'romaki')
              generateRomakiQuiz();
          });
        document
          .getElementById('endIncBtn')
          .addEventListener('click', function () {
            let end = parseInt(document.getElementById('rangeEnd').value);
            end = clamp(end + 5, 1, 46);
            document.getElementById('rangeEnd').value = end;
            if (quizType === 'range' && currentQuizMainMode === 'main')
              generateRangeQuiz();
            if (quizType === 'range' && currentQuizMainMode === 'romaki')
              generateRomakiQuiz();
          });

        document
          .getElementById('fontSelect')
          .addEventListener('change', updateJapaneseFont);

        // Initial mode
        updateVoiceMode();
        switchToNormalMode();

        // Hide advanced modes by default
        hideHiddenQuizModes();

        // Login modal logic
        document.getElementById('showLoginBtn').onclick = function () {
          document.getElementById('loginModal').style.display = 'flex';
          document.getElementById('loginError').style.display = 'none';
          document.getElementById('loginUser').value = '';
          document.getElementById('loginPass').value = '';
          document.getElementById('loginUser').focus();
        };
        document
          .getElementById('loginUser')
          .addEventListener('keydown', function (e) {
            if (e.key === 'Enter') document.getElementById('loginPass').focus();
          });
        document
          .getElementById('loginPass')
          .addEventListener('keydown', function (e) {
            if (e.key === 'Enter') doLogin();
          });
        document
          .getElementById('loginUser')
          .addEventListener('input', function () {
            document.getElementById('loginError').style.display = 'none';
          });
        document
          .getElementById('loginPass')
          .addEventListener('input', function () {
            document.getElementById('loginError').style.display = 'none';
          });
        // Hide modal on click outside
        document
          .getElementById('loginModal')
          .addEventListener('click', function (e) {
            if (e.target === this) this.style.display = 'none';
          });
      });
    </script>
  </body>
</html>
